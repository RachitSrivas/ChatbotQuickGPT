import {createContext , useContext , useState , useEffect } from "react";
import { useNavigate } from "react-router-dom";
import {dummyUserData,  dummyChats } from '../assets/assets'
import axios from 'axios' ;
import toast from 'react-hot-toast'



axios.defaults.baseURL= import.meta.env.VITE_SERVER_URL ;


const AppContext = createContext() 

export const AppContextProvider = ({children})=>{

    const navigate = useNavigate()
    const [user,setuser] = useState(null) ;
    const [chats , setchats] = useState([]) ;
    const [selectedChat , setSelectedChat] = useState(null) ;
    const [theme , setTheme] = useState(localStorage.getItem('theme') || 'light') ;
   const [token,settoken] = useState(localStorage.getItem('token') || null)

   const [loadingUser , setloadingUser] = useState(true)


     const fetchUser = async () =>{
        try {
         const {data} =   await axios.get('/api/user/data' , { headers: { Authorization: `Bearer ${token}`} })

         if(data.success){
            setuser(data.user)
         }
         else{
            toast.error(data.message)
         }

        }
         catch (error) {
             toast.error(error.message)
        }
        finally{
            setloadingUser(false)
        }
     }




     const createNewChat = async()=>{
        try {
            if(!user) return toast('Login to create new chat')
                navigate('/')

            await axios.get('/api/chat/create' ,  { headers: { Authorization: `Bearer ${token}`} })
            await fetchUsersChats()

        } catch (error) {
            toast.error(error.message)
        }
     }







     const fetchUsersChats = async()=>{
       try {
          const {data} = await axios.get('/api/chat/get' ,  { headers: { Authorization: `Bearer ${token}`} })

          if(data.success){
            setchats(data.chats)

            //if user has no chats , create one
            if(data.chats.length===0){
                await createNewChat()
                return fetchUsersChats()
            }
            else{
                setSelectedChat(data.chats[0])
            }
          }
          else{
            toast.error(data.message)
          }

       } catch (error) {
        toast.error(error.message)
       }
     }

     useEffect(()=>{
        if(theme==='dark'){
            document.documentElement.classList.add('dark') ;
        }
        else{
            document.documentElement.classList.remove('dark') ;
        }
        localStorage.setItem('theme',theme)
     },[theme])

     useEffect(()=>{
        if(user){
            fetchUsersChats() ;
        }
        else{
            setchats([]) ;
            setSelectedChat(null) ;
        }
     } , [user])

     useEffect(()=>{
        if(token){
            fetchUser() ;
        }
        else{
            setuser(null)
            setloadingUser(false)
        }
        
     },[token])



    const value = {
        navigate , user , setuser , fetchUser , chats , setchats , selectedChat , setSelectedChat , theme ,setTheme , createNewChat , loadingUser , fetchUsersChats , token , settoken 
    }



    return (
        <AppContext.Provider value={value}>
            {children}
        </AppContext.Provider>
    )
}

export const useAppContext = ()=> useContext(AppContext) 
